# TKT-202 Scheduler Safety Rollup v1

## Context
Scheduler publishes queued posts and daily metrics rollup; needs safety guardrails and pagination.

## Requirements
- Validate each scheduled payload with safety rules before publish.
- Publish approved posts to `artifacts/${APP_ID}/public/data/posts`.
- Store rejected posts under `users/{uid}/moderation` with reasons.
- Mark processed scheduled items to avoid reprocessing.
- Paginate metrics queries via `startAfter`/`limit` (1000 per page).
- Gate scheduler with `SCHEDULED_POSTS_ENABLED` env flag.

## Data Contracts
- Scheduled: `{publishAt: Timestamp, payload: Post, processedAt?: Timestamp}`.
- Posts: `{...payload, userId, createdAt}`.
- Moderation: `{payload, reasons: string[], createdAt}`.
- Metrics daily doc: `{dau, posts, shortViews, purchaseIntents, updatedAt}`.

## Acceptance Criteria
- Scheduler publishes valid posts and marks them processed.
- Rejected posts saved to moderation with violations.
- Metrics rollup counts all docs regardless of volume.

## Runtime Flags
- `SCHEDULED_POSTS_ENABLED` (bool, default false) disables scheduler when unset.

## Metrics & Budgets
- p95 latency ≤800 ms.
- Storage/egress growth ≤20 % MoM.
- Monitor function execution cost, document reads/writes.

## Risks & Mitigations
- Safety false negatives → log violations for review.
- High query costs → paginate and enforce limits.
- Flag misconfig → default off, rollback via flag toggle.

## Test Plan
- Unit tests: publish path, rejection path, pagination.
- CI: `npm ci && npm test --if-present`.

## Rollback
- Disable `SCHEDULED_POSTS_ENABLED` or redeploy previous version.
