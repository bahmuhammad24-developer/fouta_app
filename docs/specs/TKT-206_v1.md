# TKT-206 Group Roles and Moderation v1

## Context
Groups currently store an `ownerId` and `memberIds` list but lack role granularity. Moderation requires distinguishing owners from moderators and regular members.

## Requirements & Acceptance Criteria
- Introduce `roles` map on group documents with values `owner`, `moderator`, or `member`.
- Group creator is stored as `owner`.
- Owners may transfer ownership and add or remove moderators.
- Owners and moderators can edit `name`, `description`, and `coverUrl`.
- Firestore rules enforce role checks for all writes.
- Role changes require authenticated users and must not allow privilege escalation.
- Existing UI screens continue to function without modification.

## Permissions Matrix
| Action | Owner | Moderator | Member |
|-------|:----:|:---------:|:-----:|
|Edit name/description/cover|✅|✅|❌|
|Add/remove moderators|✅|❌|❌|
|Transfer ownership|✅|❌|❌|
|Join/leave|✅|✅|✅|
|Delete group|✅|❌|❌|

## Data Contracts
`artifacts/$APP_ID/public/data/groups/{groupId}`
```
{
  name: string,
  description?: string,
  coverUrl?: string,
  ownerId: string,
  memberIds: string[],
  roles: { [uid: string]: 'owner' | 'moderator' | 'member' },
  createdAt: Timestamp
}
```
- When `roles` is absent, infer `{ ownerId: 'owner' }` at read time.

## Migration Plan
1. Deploy code writing `roles` map for new groups.
2. Read path infers owner when `roles` missing; backfill optional.
3. Update security rules to reference `roles`.

## Rollback Plan
- Revert service and rules to prior version.
- Continue inferring `ownerId` as owner when `roles` absent.

## Test Plan
- Unit tests for role assignment and permission enforcement.
- `flutter analyze`, `dart format`, `flutter test`.
- Firestore rule compilation.

## Risks
1. **Privilege escalation** – mitigated by server-side and rule checks.
2. **Old documents without roles** – mitigated via read-time inference.
3. **Rule misconfiguration** – mitigated by tests and rule compilation.
4. **Performance impact** – minimal; map adds small overhead.
5. **Migration rollback** – documented above.

